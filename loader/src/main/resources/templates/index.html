<!DOCTYPE html>
<html lang="ee">
<head title="loader">
    <style>
        datalist {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            writing-mode: vertical-lr;
            width: 100%;
        }

        option {
            padding: 0;
            margin: 0;
        }

        .margin-top-8px {
            margin-top: 8px;
        }

        .slider-container {
            display: flex;
            justify-content: space-between;
            flex-direction: column;
            align-items: center;
            width: 100%;
            position: sticky;
            top: 8px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 2px;
        }

        .prey-list-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .prey-list-item {
            width: 100%;
            padding: 0 10px 0 0;
        }
    </style>

    <!-- import -->
    <!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css"/>
    <!-- import -->
</head>
<body>

<div class="container margin-top-8px">
    <div class="row">
        <div class="col" style="flex-basis: 280px">
            <input id="newPreyName" type="text" class="form-control" placeholder="Name" aria-label="Name">
        </div>

        <div class="col" style="flex-basis: 910px">
            <input id="newPreyUrl" type="url" class="form-control" placeholder="Target url" aria-label="Target url">
        </div>
    </div>

    <div class="margin-top-8px">
        <button id="addItemButton" type="button" class="btn btn-outline-primary" style="width: 100%">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
        </button>
    </div>
</div>

<div class="container margin-top-8px">
    <ul id="preyList" class="list-group list-group-flush prey-list-item"></ul>
</div>

<div class="container slider-container margin-top-8px">
    <div>
        <label class="form-label" for="rpsSlide">Load, RPS:&nbsp;</label><span class="form-label" style="font-weight: bold" id="sliderAmount">0</span>
    </div>
    <input id="rpsSlide" name="rpsSlide" type="range" min="0" max="1000" step="4" value="0" list="tickmarks" class="form-range"/>
</div>

<div class="container">
    <datalist id="tickmarks">
        <option value="0" label="disable"></option>
        <option value="100" label="100"></option>
        <option value="200" label="200"></option>
        <option value="300" label="300"></option>
        <option value="400" label="400"></option>
        <option value="500" label="500"></option>
        <option value="600" label="600"></option>
        <option value="700" label="700"></option>
        <option value="800" label="800"></option>
        <option value="900" label="900"></option>
        <option value="1000" label="1000"></option>
    </datalist>
</div>

<div id="spareParts" style="display: none">
    <button id="sparePartButtonDash" type="button" class="btn btn-outline-danger">
        <svg id="svgDash" xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-dash" viewBox="0 0 16 16">
            <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
        </svg>
    </button>

    <li id="sparePartListElement" class="list-group-item">
        <div style="display: flex; justify-content: space-between">
            <div style="flex-basis: 300px">
                <div id="sparePartName"></div>
            </div>
            <div style="flex-basis: 800px">
                <div id="sparePartUrl"></div>
            </div>
            <div style="flex-basis: 60px; display: flex; justify-content: flex-end">
                <button id="sparePartDeleteButton" type="button" class="btn btn-outline-danger">
                    <svg id="svgDash" xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-dash" viewBox="0 0 16 16">
                        <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                    </svg>
                </button>
            </div>
        </div>
    </li>
</div>

<!-- chart -->
<div id="chartContainer"></div>

<script type="text/javascript" charset="UTF-8">
    // preysToLoad["web"] = "http://localhost:8081/string/stream";
    // preysToLoad["webflux"] = "http://localhost:8082/string/stream";
    let preysToLoad = {};
    let nameToWsMap = {};
    let nameToLineChartMap = {};

    window.onload = (event) => {
        registerSlider();
        registerAddItemButton();
        reloadPreys();
    };

    function renderPrey(name, url) {
        const element = document.getElementById("sparePartListElement").cloneNode(true);
        element.setAttribute("id", "prey_" + name);

        const nameText = document.createTextNode(name);
        const nameNode = element.querySelector("#sparePartName");
        nameNode.setAttribute("id", "prey_name_" + name);
        nameNode.appendChild(nameText);

        const urlText = document.createTextNode(url);
        const urlNode = element.querySelector("#sparePartUrl");
        urlNode.setAttribute("id", "prey_url_" + name);
        urlNode.appendChild(urlText);

        const buttonNode = element.querySelector("#sparePartDeleteButton");
        buttonNode.setAttribute("id", "prey_button_" + name);

        const preyList = document.getElementById("preyList");
        preyList.appendChild(element);

        registerDeleteItemButton("prey_button_" + name, name);
    }

    function registerSlider() {
        const rpsSlide = document.getElementById('rpsSlide');
        const rpsSliderDiv = document.getElementById("sliderAmount");
        rpsSlide.onchange = function () {
            rpsSliderDiv.innerHTML = this.value;
            loadServices(this.value);
        }

        fetch("http://localhost:8088/loadParameters", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            }
        }).then(preys => preys.json())
            .then(loadParameters => {
                rpsSlide.value = loadParameters.rps;
                rpsSliderDiv.innerHTML = loadParameters.rps;
            });
    }

    function registerAddItemButton() {
        const addItemButton = document.getElementById('addItemButton');
        addItemButton.onclick = function () {
            const newPreyName = document.getElementById('newPreyName').value;
            const newPreyUrl = document.getElementById('newPreyUrl').value;

            if (!preysToLoad[newPreyName]) {
                preysToLoad[newPreyName] = newPreyUrl;

                registerPrey(newPreyName, newPreyUrl);
            }
        }
    }

    function registerDeleteItemButton(id, name) {
        const addItemButton = document.getElementById(id);
        addItemButton.onclick = function () {

            if (preysToLoad[name]) {
                unregisterPrey(name);
            }
        }
    }

    function reloadPreys() {
        fetch("http://localhost:8088/prey", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            }
        }).then(preys => preys.json())
            .then(preys => {
                const preyList = document.getElementById("preyList");
                preyList.innerHTML = "";
                const chartContainer = document.getElementById("chartContainer");
                chartContainer.innerHTML = "";
                preysToLoad = {};
                nameToWsMap = {};
                nameToLineChartMap = {};

                preys.forEach((prey, index, array) => {
                    const name = prey.name;
                    const url = prey.path;
                    preysToLoad[name] = url;
                    renderPrey(name, url);
                    renderPreyChart(name);
                    connectToWs(name);
                });
            });
    }

    function registerPrey(name, url) {
        fetch("http://localhost:8088/prey", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: `{
                "name": "${name}",
                "path": "${url}"
            }`
        }).then(date => {
            reloadPreys();
        });
    }

    function unregisterPrey(name) {
        fetch("http://localhost:8088/prey/" + name, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(date => {
            reloadPreys();
        });
    }

    function connectToWs(name) {
        const loadServiceWs = new WebSocket("ws://localhost:8088/websocket/load?" + name, []);
        nameToWsMap[name] = loadServiceWs;
        loadServiceWs.onmessage = (event) => {
            updateNamedLineChart(name, JSON.parse(event.data));
        }
    }

    function renderPreyChart(name) {
        addCanvas(name);
        const chartContainer = {};
        const totalCount = [];
        const responseTime = [];
        const successCount = [];
        const timeoutCount = [];
        const errorCount = [];
        chartContainer["totalCount"] = totalCount;
        chartContainer["responseTime"] = responseTime;
        chartContainer["successCount"] = successCount;
        chartContainer["timeoutCount"] = timeoutCount;
        chartContainer["errorCount"] = errorCount;
        chartContainer["lineChart"] = new Chart(name + "_lineChart", {
            type: "line",
            data: {
                labels: totalCount,
                datasets: [
                    {
                        label: name + ' | Response time, ms',
                        fill: false,
                        borderColor: 'rgb(0, 0, 255, 1)',
                        backgroundColor: 'rgb(0, 0, 255, 0.6)',
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 15,
                        data: responseTime,
                        yAxisID: "axisResponseTime"
                    },
                    {
                        label: name + ' | success count',
                        fill: false,
                        borderColor: 'rgb(0, 255, 0, 1)',
                        backgroundColor: 'rgb(0, 255, 0, 0.6)',
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 15,
                        data: successCount,
                        yAxisID: "axisSuccessCount"
                    },
                    {
                        label: name + ' | timeout count',
                        fill: false,
                        borderColor: 'rgb(255, 255, 0, 1)',
                        backgroundColor: 'rgb(255, 255, 0, 0.6)',
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 15,
                        data: timeoutCount,
                        yAxisID: "axisTimeoutCount"
                    },
                    {
                        label: name + ' | error count',
                        fill: false,
                        borderColor: 'rgb(255, 0, 0, 1)',
                        backgroundColor: 'rgb(255, 0, 0, 0.6)',
                        pointStyle: 'circle',
                        pointRadius: 8,
                        pointHoverRadius: 15,
                        data: errorCount,
                        yAxisID: "axisErrorsCount"
                    }
                ]
            },
            options: {
                legend: {display: true},
                title: {
                    display: true,
                    text: "p = np",
                    fontSize: 16
                },
                scales: {
                    axisResponseTime: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        text: 'response time'
                        // grid: {
                        //     drawOnChartArea: false, // only want the grid lines for one axis to show up
                        // },
                    },
                    axisTimeoutCount: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        text: 'errors count',
                        grid: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    },
                    axisErrorsCount: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        text: 'errors count',
                        grid: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    },
                    axisSuccessCount: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        text: 'success count',
                        grid: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    },
                }
            }
        });

        nameToLineChartMap[name] = chartContainer;
    }

    function updateNamedLineChart(name, report) {
        const chartContainer = nameToLineChartMap[name];
        safePush(chartContainer["responseTime"], report["endMs"] - report["startMs"]);
        const summary = report["summary"];
        safePush(chartContainer["totalCount"], summary + ' - ' + report["totalCount"]);

        if (summary === "SUCCESS") {
            const numbers = chartContainer["successCount"];
            const nextVal = getNextValue(numbers);
            safePush(numbers, nextVal);
        } else if (summary === "TIMEOUT") {
            const numbers = chartContainer["timeoutCount"];
            const nextVal = getNextValue(numbers);
            safePush(numbers, nextVal);
        } else if (summary === "ERROR") {
            const numbers = chartContainer["errorCount"];
            const nextVal = getNextValue(numbers);
            safePush(numbers, nextVal);
        }

        chartContainer["lineChart"].update();
    }

    function getNextValue(arr) {
        const size = arr.length;

        if (size === 0) {
            return 1;
        }

        return arr[arr.length - 1] + 1;
    }

    function loadServices(rps) {
        const msg = {
            rps: rps
        }

        for (const name in preysToLoad) {
            nameToWsMap[name].send(JSON.stringify(msg));
        }
    }

    function safePush(arr, element, maxSize = 100) {
        if (arr.length > maxSize) {
            arr.shift();
        }

        arr.push(element);
    }

    function addCanvas(name) {
        const newCanvas = document.createElement("canvas");
        newCanvas.setAttribute("id", name + "_lineChart");
        newCanvas.setAttribute("width", "100%");
        newCanvas.setAttribute("height", "22");
        const container = document.getElementById("chartContainer");
        container.appendChild(newCanvas);
    }

    function getRandomColor() {
        return "#" + ((1 << 24) * Math.random() | 0).toString(16);
    }
</script>

</body>
</html>
